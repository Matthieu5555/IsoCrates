# IsoCrates Docker Compose
#
# Quick start (core platform only â€” no AI generation):
#   docker compose up
#
# Full stack (with AI documentation agent):
#   docker compose --profile agent up
#
# The core platform (PostgreSQL + API + Frontend) starts by default.
# The agent profile adds the documentation generation pipeline,
# which requires OPENROUTER_API_KEY and Docker socket access.

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: isocrates-postgres
    environment:
      POSTGRES_USER: isocrates
      POSTGRES_PASSWORD: isocrates_dev
      POSTGRES_DB: isocrates
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U isocrates"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Backend API (FastAPI)
  backend-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend-api
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    environment:
      # PostgreSQL (default for docker-compose)
      DATABASE_URL: postgresql://isocrates:isocrates_dev@postgres:5432/isocrates
      # SQLite alternative (for local development without Docker):
      # DATABASE_URL: sqlite:///./isocrates.db
      ENVIRONMENT: ${ENVIRONMENT:-development}
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:3001"
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET:-}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-dev-insecure-key-change-me}
      AUTH_ENABLED: ${AUTH_ENABLED:-false}
      LOG_LEVEL: INFO
      LOG_FORMAT: ${LOG_FORMAT:-json}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Frontend (Next.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_BASE_PATH: /IsoCrates
    container_name: frontend
    ports:
      - "3001:3001"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8000
      NEXT_PUBLIC_API_URL_INTERNAL: http://backend-api:8000
      NEXT_PUBLIC_API_TOKEN: ${DOC_API_TOKEN:-}
      PORT: 3001
    depends_on:
      - backend-api
    restart: unless-stopped

  # Documentation Agent (analyzes repos with OpenHands + Claude)
  # Only starts with: docker compose --profile agent up
  #
  # ARCHITECTURE NOTE: The agent container sits idle (tail -f /dev/null) and the
  # doc-worker executes commands into it via `docker exec`. This pattern keeps the
  # agent isolated with strict security constraints while allowing the worker to
  # trigger generation jobs on demand. The trade-off is that doc-worker needs
  # Docker socket access (/var/run/docker.sock).
  doc-agent:
    profiles: ["agent"]
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: doc-agent
    environment:
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      OPENROUTER_API_KEY_FILE: /run/secrets/openrouter_api_key  # Docker secrets support
      LLM_MODEL: openrouter/anthropic/claude-3.5-sonnet
      LLM_API_KEY: ${OPENROUTER_API_KEY}
      LLM_BASE_URL: https://openrouter.ai/api/v1
      SANDBOX_TYPE: local
      DOC_API_URL: http://backend-api:8000
      DOC_API_TOKEN: ${DOC_API_TOKEN:-}
      REPOS_DIR: /repos
      NOTES_DIR: /tmp/notes
    volumes:
      # SECURITY: Read-only agent code
      - ./agent:/workspace:ro
      # SECURITY: Read-write repos with security options
      - ./repos:/repos:rw,nosuid,nodev
    # SECURITY: Read-only root filesystem (agent shouldn't write to system)
    read_only: false  # OpenHands needs write access to /tmp
    tmpfs:
      # SECURITY: Temp directory with no-exec, size limit
      - /tmp:rw,noexec,nosuid,size=1g
    working_dir: /workspace
    depends_on:
      - backend-api
    command: tail -f /dev/null
    restart: unless-stopped

    # SECURITY: Remove privileged mode
    privileged: false

    # SECURITY: Drop all capabilities, add only needed ones
    cap_drop:
      - ALL
    cap_add:
      - CHOWN         # For git operations
      - DAC_OVERRIDE  # For file access

    # SECURITY: Prevent privilege escalation
    security_opt:
      - no-new-privileges:true

    # SECURITY: Resource limits
    mem_limit: 4g
    memswap_limit: 4g
    pids_limit: 200

    # SECURITY: Use non-root user (requires Dockerfile update)
    # user: "1000:1000"

  # Worker: polls for queued generation jobs and runs the agent
  # Only starts with: docker compose --profile agent up
  doc-worker:
    profiles: ["agent"]
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: doc-worker
    environment:
      DATABASE_URL: postgresql://isocrates:isocrates_dev@postgres:5432/isocrates
      AGENT_SCRIPT_PATH: /workspace/openhands_doc.py
      AGENT_MODE: docker
      AGENT_CONTAINER: doc-agent
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      DOC_API_URL: http://backend-api:8000
      DAILY_REFRESH_INTERVAL: "86400"  # 24 hours
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock  # Access to exec into doc-agent
    working_dir: /app
    command: python worker.py
    depends_on:
      - backend-api
      - doc-agent
      - postgres
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  default:
    name: autodoc-network

# SECURITY: Docker secrets for sensitive credentials
# Uncomment to use secrets in production (requires creating secrets/openrouter_api_key.txt)
# secrets:
#   openrouter_api_key:
#     file: ./secrets/openrouter_api_key.txt
